---
title: "Diagnose smoothing"
output: html_document
date: "2025-12-09"
---

```{r diagnose smoothing}


rmarkdown::render("01a_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_plots_smoothed_fd.Rmd", envir = globalenv(), quiet = TRUE)


library(pracma)

compute_residual_error <- function(raw, smooth, Time) {
  # raw: matrix (time × curves)
  # smooth: matrix (grid × curves)
  
  yhat <- apply(smooth, 2, function(s) approx(grid, s, xout = Time)$y)
  
  rse <- colMeans((raw - yhat)^2, na.rm = TRUE)
  sqrt(rse)
}


residual_errors <- lapply(seq_along(all_fd_groups), function(i) {
  raw  <- all_groups[[i]]      # original data matrix
  fd   <- all_fd_groups[[i]]
  sm   <- eval.fd(grid, fd)         # smoothed matrix
  compute_residual_error(raw, sm, Time)
})

residual_errors


compute_roughness <- function(fd_obj) {
  d2 <- eval.fd(grid, fd_obj, Lfdobj = 2)  # second derivative
  apply(d2^2, 2, function(x) trapz(grid, x))
}

roughness <- lapply(all_fd_groups, compute_roughness)

roughness




stability_test <- function(group_raw) {
  
  noise_sd <- 0.02 * apply(group_raw, 1, sd, na.rm = TRUE)
  noise <- matrix(rnorm(length(group_raw), 0, rep(noise_sd, ncol(group_raw))),
                  nrow = nrow(group_raw), byrow = FALSE)
  
  raw_perturbed <- group_raw + noise
  
  # Smooth original
  sm0 <- eval.fd(grid, smooth_group(group_raw))
  # Smooth perturbed
  sm1 <- eval.fd(grid, smooth_group(raw_perturbed))
  
  mean(abs(sm0 - sm1))
}



compute_stability <- function(fd_obj) {
  sm0 <- eval.fd(grid, fd_obj)
  
  noise <- matrix(rnorm(length(sm0), 0, sd(sm0)*0.05),
                  nrow = nrow(sm0), byrow = FALSE)
  
  sm1 <- sm0 + noise
  mean(abs(sm0 - sm1))
}

stability <- lapply(all_fd_groups, compute_stability)

stability


compute_derivative_energy <- function(fd_obj) {
  d1 <- eval.fd(grid, fd_obj, Lfdobj = 1)
  d2 <- eval.fd(grid, fd_obj, Lfdobj = 2)
  
  e1 <- apply(d1^2, 2, function(x) trapz(grid, x))
  e2 <- apply(d2^2, 2, function(x) trapz(grid, x))
  
  list(d1_energy = e1, d2_energy = e2)
}

derivative_energy <- lapply(all_fd_groups, compute_derivative_energy)

derivative_energy






compute_variance_reduction <- function(raw, fd_obj) {
  sm <- eval.fd(grid, fd_obj)
  
  # align sm to Time
  sm_at_raw <- apply(sm, 2, function(s) approx(grid, s, xout = Time)$y)
  
  var_raw <- apply(raw, 1, var, na.rm = TRUE)
  var_smooth <- apply(sm_at_raw, 1, var, na.rm = TRUE)
  
  mean(var_smooth) / mean(var_raw)
}

var_reduction <- mapply(compute_variance_reduction,
                        all_groups, all_fd_groups)

var_reduction



summary_df <- data.frame(
  group = groups_names,
  residual_mean = sapply(residual_errors, mean),
  roughness_mean = sapply(roughness, mean),
  stability = sapply(stability, identity),
  var_ratio = var_reduction
)

summary_df




boxplot(residual_errors, main="Residual Error per Group", las=2)

boxplot(roughness, main="Roughness per Group", las=2)

barplot(var_reduction, names.arg = groups_names,
        main = "Variance Reduction (smoothed/raw)")

```



How to interpret the results
Good smoothing when:

Residual errors: low, no structure

Roughness: moderate, similar across curves

Stability: small values (<5% of signal range)

Var reduction: 0.2–0.7

First derivative smooth

Second derivative not too spiky

Bad smoothing when:

Residual very low + roughness high → overfit

Residual high + roughness low → underfit

Instability high → fragile

Var reduction ≈ 1 → doing nothing

Var reduction < 0.1 → signal destroyed










