---
title: "plots amplitude diff via Bootstrap SCBs"
output: html_document
date: "2025-11-21"
---

```{r Global SCB comparaison}

###############################################################
###  MODULE  — SCB Bootstrap Comparisons and Cohen's d(t) Analysis Script
###  Goal: Compare selected groups using simultaneous confidence bands
###############################################################


rmarkdown::render("01a_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("02_local_outlier_handling.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("04_mean_and_variance_functions.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("06_scb_bootstrap.Rmd", envir = globalenv(), quiet = TRUE)

set.seed(1234)

###############################################################
### 1. Automatically generate comparisons
###############################################################


groups <- names(fd_groups)
all_comparisons <- combn(groups, 2, simplify = FALSE)


#selected_age <- "Juvenile"  # or NULL to not filter by age

specific_comp <- Filter(function(x) {
  parts1 <- strsplit(x[1], " ")[[1]]
  parts2 <- strsplit(x[2], " ")[[1]]
  
  sex1 <- parts1[1]
  sex2 <- parts2[1]
  
  age1 <- parts1[length(parts1)]
  age2 <- parts2[length(parts2)]
  
  same_sex <- sex1 == sex2
  same_age <- if (is.null(selected_age)) TRUE else (age1 == selected_age && age2 == selected_age)
  
  same_sex && same_age && (
    (grepl("HRM", x[1]) && grepl("WT", x[2])) ||
    (grepl("WT", x[1]) && grepl("HRM", x[2]))
  )
}, all_comparisons)





# specific_comp <- Filter(function(x) {
#   # Extract gen and age
#   parts1 <- strsplit(x[1], " ")[[1]]
#   parts2 <- strsplit(x[2], " ")[[1]]
#   
#   gen1 <- parts1[1]
#   gen2 <- parts2[1]
#   
#   age1 <- parts1[length(parts1)]  # age last word
#   age2 <- parts2[length(parts2)]
#   
#   same_gen <- gen1 == gen2
#   same_age <- age1 == age2
#   
#   
#   same_gen && same_age && (
#     (grepl("Males", x[1]) && grepl("Females", x[2])) ||
#     (grepl("Females", x[1]) && grepl("Males", x[2]))
#   )
# }, all_comparisons)




# specific_comp <- Filter(function(x) {
#   # Extract sexe and gen
#   parts1 <- strsplit(x[1], " ")[[1]]
#   parts2 <- strsplit(x[2], " ")[[1]]
#   
#   sex1 <- parts1[1]
#   sex2 <- parts2[1]
#   
#   gen1 <- parts1[length(parts1)]  
#   gen2 <- parts2[length(parts2)]
#   
#   same_sex <- sex1 == sex2
#   same_gen <- gen1 == gen2
#   
#   
#   same_sex && same_gen && (
#     (grepl("Males", x[1]) && grepl("Females", x[2])) ||
#     (grepl("Females", x[1]) && grepl("Males", x[2]))
#   )
# }, all_comparisons)



###############################################################
### 2. Compute SCB for selected comparisons
###############################################################

scb_results <- setNames(
  lapply(specific_comp, function(pair) {
    cat("Computing SCB:", pair[1], "vs", pair[2], "\n")
    Bootstrap_scb_difference(
      fd_groups[[pair[1]]],
      fd_groups[[pair[2]]],
      n_bootstrap = 1000,
      Time = Time
    )
  }),
  sapply(specific_comp, function(pair) paste(pair, collapse = "_vs_"))
)

###############################################################
### 3. Multiple-testing correction
###############################################################

raw_pvals <- sapply(scb_results, function(res) res$p_value)
pvals_holm <- p.adjust(raw_pvals, method = "holm")
pvals_BH   <- p.adjust(raw_pvals, method = "BH")
pvals_Bonferroni <- p.adjust(raw_pvals, method = "bonferroni")

scb_summary_table <- data.frame(
  Comparison = names(scb_results),
  p_raw = round(raw_pvals,4),
  p_Holm = round(pvals_holm,4),
  p_BH = round(pvals_BH,4),
  p_Bonferroni = round(pvals_Bonferroni,4),
  stringsAsFactors = FALSE
)

if (!dir.exists("SCB_summary_stat")) dir.create("SCB_summary_stat")
png("SCB_summary_stat/SCB_summary_table.png", width = 1600, height = 600, res = 150)
grid.table(scb_summary_table)
dev.off()

###############################################################
### 4. Functions to plot SCB and Cohen's d(t)
###############################################################

plot_scb <- function(Time, scb, title, global_min, global_max) {
  plot(Time, scb$mean, type = "l", col = "black", lwd = 2,
       ylim = c(global_min, global_max),
       xlab = "Time (sec)", ylab = "fEPSP Diff.",
       main = title, cex.main = 1.1)
  lines(Time, scb$lower, col = "blue", lty = 2)
  lines(Time, scb$upper, col = "blue", lty = 2)
  abline(h = 0, col = "red", lty = 2)
  abline(v = c(360, 1740), col = "black", lty = 3)
  polygon(c(Time, rev(Time)),
          c(scb$lower, rev(scb$upper)),
          col = rgb(0.5, 0.5, 0, 0.3), border = NA)
  legend("bottomright",
         legend = c("Mean Diff.", "95% SCB"),
         col = c("black", "blue"),
         lwd = c(2, 1), lty = c(1, 2),
         cex = 0.7, bty = "n")
}

plot_cohen_d <- function(Time, d_curve, title, global_max) {
  plot(Time, abs(d_curve), type = "l", lwd = 2, col = "purple",
       xlab = "Time (sec)", ylab = "Cohen's |d(t)|",
       main = paste("Cohen's |d(t)| -", title),
       ylim = c(0, global_max))
  abline(h = 0, col = "red", lty = 2)
  abline(v = c(360, 1740), col = "black", lty = 3)
  abline(h = c(0.2, 0.5, 0.8), col = c("blue", "orange", "green"), lty = 3)
  legend("topright",
         legend = c("d(t)", "0.2 small", "0.5 medium", "0.8 large"),
         col = c("purple", "blue", "orange", "green"),
         lty = c(1, 2, 3, 4),
         cex = 0.7, bty = "n")
}

plot_all_cohen_same_graph <- function(Time, scb_results, global_max) {
  comps <- names(scb_results)
  n <- length(comps)
  colors <- brewer.pal(min(n, 8), "Set1") 
  if (n > 8) colors <- rainbow(n)

  plot(Time, type = "n", ylim = c(0, global_max), xlab = "Time (sec)",
       ylab = "Cohen's |d(t)|",
       main = "Cohen's |d(t)| for all comparisons")
  abline(h = 0, col = "red", lty = 2)
  abline(v = c(360, 1740), col = "black", lty = 3)
  abline(h = c(0.2, 0.5, 0.8), col = c("blue", "orange", "green"), lty = 3)

  for (i in seq_along(comps)) {
    lines(Time, abs(scb_results[[comps[i]]]$d_curve),
          col = colors[i %% length(colors) + 1], lwd = 2)
  }

  legend("topright", legend = comps, col = colors, lty = 1, lwd = 2, cex = 0.7, bty = "n")
}

###############################################################
### 5. Export SCB and Cohen's d figures
###############################################################

if (!dir.exists("figures_cohen_d")) dir.create("figures_cohen_d")
if (!dir.exists("figures_same_graph_cohen_d")) dir.create("figures_same_graph_cohen_d")
if (!dir.exists("figures_scb_comparaison")) dir.create("figures_scb_comparaison")

global_min_scb <- min(sapply(scb_results, function(res) min(res$lower, na.rm = TRUE)))
global_max_scb <- max(sapply(scb_results, function(res) max(res$upper, na.rm = TRUE)))
global_max_d <- max(sapply(scb_results, function(res) max(abs(res$d_curve), na.rm = TRUE)))

# Individual SCB and Cohen's d
for (comparison in names(scb_results)) {
  png(paste0("figures_scb_comparaison/", comparison, ".png"), width = 1200, height = 800, res = 150)
  plot_scb(Time, scb_results[[comparison]], gsub("_", " ", comparison), global_min_scb, global_max_scb)
  dev.off()

  png(paste0("figures_cohen_d/", comparison, ".png"), width = 1200, height = 800, res = 150)
  plot_cohen_d(Time, scb_results[[comparison]]$d_curve, gsub("_", " ", comparison), global_max_d)
  dev.off()
}

# All Cohen's d on the same graph
png("figures_same_graph_cohen_d/all_comparisons_cohen_d.png", width = 1600, height = 900, res = 150)
plot_all_cohen_same_graph(Time, scb_results, global_max = global_max_d)
dev.off()

###############################################################
### 6. Export summary statistics PDF
###############################################################

summary_df <- data.frame(
  Comparison = names(scb_results),
  p_raw = sapply(scb_results, function(x) round(x$p_value, 4)),
  p_Holm = round(pvals_holm, 4),
  p_BH = round(pvals_BH, 4),
  p_Bonf = round(pvals_Bonferroni, 4),
  z_alpha = sapply(scb_results, function(x) round(x$z_alpha, 4)),
  sup_obs = sapply(scb_results, function(x) round(x$sup_obs, 4)),
  d_mean = sapply(scb_results, function(x) round(x$d_mean, 4))
)

pdf("SCB_summary_stat/SCB_summary_statistics.pdf", width = 14, height = 8)
lines_per_page <- 15  
n_pages <- ceiling(nrow(summary_df) / lines_per_page)
for (i in 1:n_pages) {
  start_row <- (i-1)*lines_per_page + 1
  end_row <- min(i*lines_per_page, nrow(summary_df))
  grid.newpage()
  grid.table(summary_df[start_row:end_row, ], rows = NULL)
}
dev.off()

```



```{r}
all_comparisons

```




















































```{r Three phases SCB comparaison}

###############################################################
###  MODULE  — SCB Bootstrap Comparisons at three phases
###  Goal: Compare selected groups using simultaneous confidence bands on three phases
###############################################################

set.seed(1234)

phase1_idx <- which(Time >= 1   & Time <= 360)
phase2_idx <- which(Time >= 361 & Time <= 1740)
phase3_idx <- which(Time >= 1741 & Time <= 2400)

Time_phases <- list(
  Phase1 = Time[phase1_idx],
  Phase2 = Time[phase2_idx],
  Phase3 = Time[phase3_idx]
)



##############################################################################
###########################Three phases comp ##################################
###############################################################################

#------Computing comparaisons-----------

scb_results_phases <- list()

for (phase_name in names(Time_phases)) {
  
  Time_subset <- Time_phases[[phase_name]]
  
  cat("\n===== Computing SCB for", phase_name, "=====\n")
  
  scb_results_phases[[phase_name]] <- setNames(
    lapply(specific_comp, function(pair) {
      group1 <- pair[1]
      group2 <- pair[2]
      
      cat("  -", group1, "vs", group2, "\n")
      
      Bootstrap_scb_difference(
        fd_groups[[group1]],
        fd_groups[[group2]],
        n_bootstrap = 1000,
        Time = Time_subset
      )
    }),
    sapply(specific_comp, function(pair) paste(pair, collapse = "_vs_"))
  )
}

#------Plot Computing comparaisons-----------

plot_scb_three_phases <- function(
  Time1, scb1,
  Time2, scb2,
  Time3, scb3,
  title = "SCB Comparison (3 phases)"
){
  
  ymin <- min(c(scb1$lower, scb2$lower, scb3$lower))
  ymax <- max(c(scb1$upper, scb2$upper, scb3$upper))
  xmin <- min(c(Time1, Time2, Time3))
  xmax <- max(c(Time1, Time2, Time3))
  
  
  plot(Time1, scb1$mean, type="n",
       ylim=c(ymin, ymax),
       xlim=c(xmin, xmax),
       xlab="Time (sec)", ylab="Mean Difference",
       main=title)
  
  # Phase 1 
  polygon(
    c(Time1, rev(Time1)),
    c(scb1$lower, rev(scb1$upper)),
    col=rgb(0,0,1,0.25), border=NA
  )
  lines(Time1, scb1$mean, col="blue", lwd=2)
  lines(Time1, scb1$lower, col="blue", lty=2)
  lines(Time1, scb1$upper, col="blue", lty=2)
  
  # Phase 2 
  polygon(
    c(Time2, rev(Time2)),
    c(scb2$lower, rev(scb2$upper)),
    col=rgb(1,0.5,0,0.25), border=NA
  )
  lines(Time2, scb2$mean, col="orange", lwd=2)
  lines(Time2, scb2$lower, col="orange", lty=2)
  lines(Time2, scb2$upper, col="orange", lty=2)
  
  # Phase 3 
  polygon(
    c(Time3, rev(Time3)),
    c(scb3$lower, rev(scb3$upper)),
    col=rgb(0,0.6,0,0.25), border=NA
  )
  lines(Time3, scb3$mean, col="darkgreen", lwd=2)
  lines(Time3, scb3$lower, col="darkgreen", lty=2)
  lines(Time3, scb3$upper, col="darkgreen", lty=2)
  
  
  abline(h=0, col="red", lty=2)
  
  
  legend("bottomright",
         legend=c(
           "Phase 1 (1–360s)",
           "Phase 2 (361–1740s)",
           "Phase 3 (1741–2400s)"
         ),
         col=c("blue","orange","darkgreen"),
         lwd=2, bty="n")
}


#------Save Computing comparaisons-----------

dir.create("figures_scb_three_phases", showWarnings = FALSE)

for (comparison in names(scb_results_phases$Phase1)) {
  
  png(
    filename = paste0("figures_scb_three_phases/", comparison, "_3phases.png"),
    width = 1500, height = 900, res = 150
  )
  
  plot_scb_three_phases(
    Time_phases$Phase1,
    scb_results_phases$Phase1[[comparison]],
    
    Time_phases$Phase2,
    scb_results_phases$Phase2[[comparison]],
    
    Time_phases$Phase3,
    scb_results_phases$Phase3[[comparison]],
    
    title = paste("SCB Comparison for", gsub("_", " ", comparison),
                  "- (Three Time Phases)")
  )
  
  dev.off()
}



##############################################################################
#######################Three phases cohen's d curves##########################
###############################################################################

#------Computing cohen's d curves-----------

cohen_d_phases <- list()

for (phase_name in names(Time_phases)) {
  Time_subset <- Time_phases[[phase_name]]

  cohen_d_phases[[phase_name]] <- lapply(
    scb_results_phases[[phase_name]],
    function(res) res$d_curve   # ← déjà correct !
  )
  
  names(cohen_d_phases[[phase_name]]) <- names(scb_results_phases[[phase_name]])
}

#------Plot cohen's d curves-----------

plot_cohen_three_phases <- function(
  Time1, d1,
  Time2, d2,
  Time3, d3,
  title="Cohen's d (3 phases)"
){
  ymax <- max(abs(c(d1, d2, d3)))

  plot(Time1, abs(d1), type="n",
       ylim=c(0, ymax),
       xlim=c(min(Time1), max(Time3)),
       xlab="Time (s)", ylab="|d(t)|",
       main=title)

  lines(Time1, abs(d1), col="blue", lwd=2)
  lines(Time2, abs(d2), col="orange", lwd=2)
  lines(Time3, abs(d3), col="darkgreen", lwd=2)

  abline(h=c(0.2, 0.5, 0.8), col="gray40", lty=3)

  legend("topright",
         legend=c("Phase1","Phase2","Phase3"),
         col=c("blue","orange","darkgreen"), lwd=2, bty="n")
}


#------Save cohen's d curves plots-----------

dir.create("figures_cohen_d_three_phases", showWarnings = FALSE)

for (comparison in names(cohen_d_phases$Phase1)) {
  
  png(
    filename = paste0("figures_cohen_d_three_phases/", comparison, "_3phases.png"),
    width = 1500, height = 900, res = 150
  )
  
  plot_cohen_three_phases(
    Time_phases$Phase1, cohen_d_phases$Phase1[[comparison]],
    Time_phases$Phase2, cohen_d_phases$Phase2[[comparison]],
    Time_phases$Phase3, cohen_d_phases$Phase3[[comparison]],
    title = paste("Cohen's d for", gsub("_", " ", comparison))
  )
  
  dev.off()
}



##############################################################################
#######################SCB's summary statitics##########################
###############################################################################

library(gridExtra)
library(grid)
dir.create("SCB_summary_statistics_three_phases", showWarnings = FALSE)


summary_phases <- list()

for (phase_name in names(scb_results_phases)) {

  scb_list <- scb_results_phases[[phase_name]]

  raw_pvals <- sapply(scb_list, function(x) x$p_value)
  
  summary_df <- data.frame(
    Phase = phase_name,
    Comparison = names(scb_list),
    p_raw = round(raw_pvals, 5),
    p_Holm = round(p.adjust(raw_pvals, method="holm"), 5),
    p_BH = round(p.adjust(raw_pvals, method="BH"), 5),
    p_Bonf = round(p.adjust(raw_pvals, method="bonferroni"), 5),
    z_alpha = round(sapply(scb_list, function(x) x$z_alpha), 4),
    sup_obs = round(sapply(scb_list, function(x) x$sup_obs), 4),
    d_mean = round(sapply(scb_list, function(x) x$d_mean), 4),
    stringsAsFactors = FALSE
  )
  
  summary_phases[[phase_name]] <- summary_df
}

summary_all_phases <- do.call(rbind, summary_phases)


lines_per_page <- 15  
n_pages <- ceiling(nrow(summary_all_phases)/lines_per_page)

pdf("SCB_summary_statistics_three_phases/SCB_summary_statistics.pdf", width = 14, height = 8)

for (i in 1:n_pages) {
  start_row <- (i-1)*lines_per_page + 1
  end_row <- min(i*lines_per_page, nrow(summary_all_phases))
  grid.newpage()
  grid.table(summary_all_phases[start_row:end_row, ], rows = NULL)
}

dev.off()
```















