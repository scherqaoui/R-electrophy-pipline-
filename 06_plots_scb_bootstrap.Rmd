---
title: "plots amplitude diff via Bootstrap SCBs"
output: html_document
date: "2025-11-21"
---

```{r }

###############################################################
###  MODULE  â€” SCB Bootstrap Comparisons
###  Goal: Compare selected groups using simultaneous confidence bands
###############################################################


rmarkdown::render("01a_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("02_local_outlier_handling.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("04_mean_and_variance_functions.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("06_scb_bootstrap.Rmd", envir = globalenv(), quiet = TRUE)

set.seed(1234)

###############################################################
### 1. Selecting manually the group comparisons of interest
###    (avoiding useless comparisons)
###############################################################

specific_comp <- list(
  
  #--------------Genotypes comparisons: (age,sex) fixed -------------------
  
  #Juvenile
  #c("Males HRM Juvenile", "Males WT Juvenile"),
  #c("Females HRM Juvenile", "Females WT Juvenile"),
  
  #Adolescent
  #c("Males HRM Adolescent", "Males WT Adolescent"),
  #c("Females HRM Adolescent", "Females WT Adolescent"),
  
  #Adult
  #c("Males HRM Adult", "Males WT Adult"),
  #c("Females HRM Adult", "Females WT Adult"),
  
  #Age
  c("Males HRM Aged", "Males WT Aged")
  #c("Females HRM Aged", "Females WT Aged"),
  

  #--------- Developmental stages comparisons: (sex,genotype) fixed ---------

  # Males - HRM
  #c("Males HRM Juvenile",   "Males HRM Adolescent"),
  #c("Males HRM Juvenile",   "Males HRM Adult"),
  #c("Males HRM Juvenile",   "Males HRM Aged"),
  #c("Males HRM Adolescent", "Males HRM Adult"),
  #c("Males HRM Adolescent", "Males HRM Aged"),
  #c("Males HRM Adult",      "Males HRM Aged"),

  # Males - WT
  #c("Males WT Juvenile",    "Males WT Adolescent"),
  #c("Males WT Juvenile",    "Males WT Adult"),
  #c("Males WT Juvenile",    "Males WT Aged"),
  #c("Males WT Adolescent",  "Males WT Adult"),
  #c("Males WT Adolescent",  "Males WT Aged"),
  #c("Males WT Adult",       "Males WT Aged"),
  

  # Females - HRM
  #c("Females HRM Juvenile",    "Females HRM Adolescent"),
  #c("Females HRM Juvenile",    "Females HRM Adult"),
  #c("Females HRM Juvenile",    "Females HRM Aged"),
  #c("Females HRM Adolescent",  "Females HRM Adult"),
  #c("Females HRM Adolescent",  "Females HRM Aged"),
  #c("Females HRM Adult",       "Females HRM Aged"),

  # Females - WT
  #c("Females WT Juvenile",     "Females WT Adolescent"),
  #c("Females WT Juvenile",     "Females WT Adult"),
  #c("Females WT Juvenile",     "Females WT Aged"),
  #c("Females WT Adolescent",   "Females WT Adult"),
  #c("Females WT Adolescent",   "Females WT Aged"),
  #c("Females WT Adult",        "Females WT Aged")
)

###############################################################
### 2. Compute SCBs for selected comparisons
###############################################################

scb_results <- setNames(
  lapply(specific_comp, function(pair) {
    group1 <- pair[1]
    group2 <- pair[2]

    cat("Computing SCB:", group1, "vs", group2, "\n")

    Bootstrap_scb_difference(
      fd_groups[[group1]],
      fd_groups[[group2]],
      n_bootstrap = 1000,
      Time = Time
    )
  }),
  sapply(specific_comp, function(pair) paste(pair, collapse = "_vs_"))
)




###############################################################
### Multiple-testing correction (Holm or BH)
###############################################################


# Extract raw p-values from all SCB results
raw_pvals <- sapply(scb_results, function(res) res$p_value)

# Apply corrections
pvals_holm <- p.adjust(raw_pvals, method = "holm")
pvals_BH   <- p.adjust(raw_pvals, method = "BH")

# Create a summary table
scb_summary_table <- data.frame(
  Comparison = names(scb_results),
  p_raw      = raw_pvals,
  p_holm     = pvals_holm,
  p_BH       = pvals_BH,
  stringsAsFactors = FALSE
)

print(scb_summary_table)

if (!dir.exists("SCB_summary_stat")) dir.create("SCB_summary_stat")
write.csv(scb_summary_table, "SCB_summary_stat/pvalues_corrected.csv", row.names = FALSE)




###############################################################
### 3. Function to plot SCBs comparaison
###############################################################

plot_scb <- function(Time, scb, title) {
  plot(Time, scb$mean, type = "l", col = "black", lwd = 2,
       ylim = range(c(scb$lower, scb$upper)),
       xlab = "Time (sec)", ylab = "fEPSP Diff.",
       main = title, cex.main = 1.1)

  lines(Time, scb$lower, col = "blue", lty = 2)
  lines(Time, scb$upper, col = "blue", lty = 2)
  abline(h = 0, col = "red", lty = 2)

  polygon(c(Time, rev(Time)),
          c(scb$lower, rev(scb$upper)),
          col = rgb(0.5, 0.5, 0, 0.3), border = NA)

  legend("bottomright",
         legend = c("Mean Diff.", "95% SCB"),
         col = c("black", "blue"),
         lwd = c(2, 1), lty = c(1, 2),
         cex = 0.7, bty = "n")
}



###############################################################
### 4. Function to plot cohen's d function 
###############################################################

plot_cohen_d <- function(Time, d_curve, title) {
  plot(Time, d_curve, type = "l", lwd = 2, col = "purple",
       xlab = "Time (sec)", ylab = "Cohen's d(t)",
       main = paste("Cohen's d(t) -", title))
  abline(h = 0, col = "red", lty = 2)
  abline(h = c(0.2, 0.5, 0.8), col = "gray", lty = 3)
  legend("topright",
         legend = c("d(t)", "0.2 small", "0.5 medium", "0.8 large"),
         col = c("purple", "gray", "gray", "gray"),
         lty = c(1, 3, 3, 3),
         cex = 0.7, bty = "n")
}



###############################################################
### 5. Plot all cohen's d comparaison
###############################################################
if (!dir.exists("figures_cohen_d")) dir.create("figures_cohen_d")


for (comparison in names(scb_results)) {
  
  file_name <- paste0("figures_cohen_d/", groups_names[i], ".png")
  png(filename = file_name, width = 1200, height = 800, res = 150)
  
  plot_cohen_d(
    Time,
    scb_results[[comparison]]$d_curve,
    gsub("_", " ", comparison)
  )
  dev.off()
}


###############################################################
### 5. Plot all SCBs comparaison
###############################################################


if (!dir.exists("figures_scb_comparaison")) dir.create("figures_scb_compariason")


for (comparison in names(scb_results)) {
  
  file_name <- paste0("figures_scb_comparaison/", groups_names[i], ".png")
  png(filename = file_name, width = 1200, height = 800, res = 150)
  
  plot_scb(
    Time,
    scb_results[[comparison]],
    gsub("_", " ", comparison)
  )
  
  dev.off()
}

###############################################################
### 6. Summary statistics
###############################################################

cat("\n===== SCB SUMMARY STATISTICS =====\n")

for (comparison in names(scb_results)) {
  res <- scb_results[[comparison]]
  
  cat("\nComparison:", gsub("_", " ", comparison), "\n")
  cat("  raw p-value:        ", round(res$p_value, 4), "\n")
  cat("  Holm corrected:     ", round(pvals_holm[comparison], 4), "\n")
  cat("  BH corrected:       ", round(pvals_BH[comparison], 4), "\n")
  cat("  z_alpha:            ", round(res$z_alpha, 4), "\n")
  cat("  sup_obs:            ", round(res$sup_obs, 4), "\n")
  cat("  mean(cohen's d):    ", round(res$d_mean, 4), "\n")

}


if (!dir.exists("SCB_summary_stat")) dir.create("SCB_summary_stat")

library(gridExtra)

png("SCB_summary_stat/_scb_summary_stat.png", width = 1600, height = 600, res = 150)
grid.table(anova_table3)
dev.off()


```



















