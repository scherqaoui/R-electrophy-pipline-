---
title: "Smoothed Functional Data — Group Curves"
output: html_document
date: "2025-11-21"
---

```{r plots fd data}

rmarkdown::render("01a_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)





#-------------------------Plot group's curves------------------------


grid <- seq(min(Time), max(Time), length.out = 500)

all_vals <- unlist(lapply(all_fd_groups, function(fd) eval.fd(grid, fd)))
ylim_global <- range(all_vals)
ylim_global


plot_gp_curves <- function(fd_gp, title_gp, col, lty,
                         ylim_global = NULL) {
  
  
  grid <- seq(min(Time), max(Time), length.out = 500)
  mat  <- eval.fd(grid, fd_gp)    
  
  #first curves
  plot(grid, mat[, 1],type='l', col = col,lty=lty, lwd = 2,
       main = title_gp, xlab = "Time (sec)", ylab = "fESPS % of baseline",
       ylim = ylim_global)
  
  #adding the other curves of the group
  if (ncol(mat) > 1) {
    for (i in 2:ncol(mat)) {
      lines(grid, mat[, i],lty= lty, col = col, lwd = 2)
    }
  }
}

if (!dir.exists("figures_smooth_data")) dir.create("figures_smooth_data")

for (i in 1:length(all_fd_groups)) {
  
  file_name <- paste0("figures_smooth_data/", groups_names[i], ".png")
  
  png(filename = file_name, width = 1200, height = 800, res = 150)
  
  plot_gp_curves(
    fd_gp = all_fd_groups[[i]],
    title_gp = groups_names[i],
    col = colors[i],
    lty =lty[i],
    ylim_global = ylim_global
    
    
  )
  abline(h = 150, col = "black", lwd = 2, lty = 2)
  grid()
  
  dev.off()
}

```


```{r}
library(pracma)

compute_residual_error <- function(raw, smooth, Time) {
  # raw: matrix (time × curves)
  # smooth: matrix (grid × curves)
  
  yhat <- apply(smooth, 2, function(s) approx(grid, s, xout = Time)$y)
  
  rse <- colMeans((raw - yhat)^2, na.rm = TRUE)
  sqrt(rse)
}


residual_errors <- lapply(seq_along(all_fd_groups), function(i) {
  raw  <- all_groups[[i]]      # original data matrix
  fd   <- all_fd_groups[[i]]
  sm   <- eval.fd(grid, fd)         # smoothed matrix
  compute_residual_error(raw, sm, Time)
})

residual_errors


compute_roughness <- function(fd_obj) {
  d2 <- eval.fd(grid, fd_obj, Lfdobj = 2)  # second derivative
  apply(d2^2, 2, function(x) trapz(grid, x))
}

roughness <- lapply(all_fd_groups, compute_roughness)

roughness




stability_test <- function(group_raw) {
  
  noise_sd <- 0.02 * apply(group_raw, 1, sd, na.rm = TRUE)
  noise <- matrix(rnorm(length(group_raw), 0, rep(noise_sd, ncol(group_raw))),
                  nrow = nrow(group_raw), byrow = FALSE)
  
  raw_perturbed <- group_raw + noise
  
  # Smooth original
  sm0 <- eval.fd(grid, smooth_group(group_raw))
  # Smooth perturbed
  sm1 <- eval.fd(grid, smooth_group(raw_perturbed))
  
  mean(abs(sm0 - sm1))
}



compute_stability <- function(fd_obj) {
  sm0 <- eval.fd(grid, fd_obj)
  
  noise <- matrix(rnorm(length(sm0), 0, sd(sm0)*0.05),
                  nrow = nrow(sm0), byrow = FALSE)
  
  sm1 <- sm0 + noise
  mean(abs(sm0 - sm1))
}

stability <- lapply(all_fd_groups, compute_stability)

stability


compute_derivative_energy <- function(fd_obj) {
  d1 <- eval.fd(grid, fd_obj, Lfdobj = 1)
  d2 <- eval.fd(grid, fd_obj, Lfdobj = 2)
  
  e1 <- apply(d1^2, 2, function(x) trapz(grid, x))
  e2 <- apply(d2^2, 2, function(x) trapz(grid, x))
  
  list(d1_energy = e1, d2_energy = e2)
}

derivative_energy <- lapply(all_fd_groups, compute_derivative_energy)

derivative_energy






compute_variance_reduction <- function(raw, fd_obj) {
  sm <- eval.fd(grid, fd_obj)
  
  # align sm to Time
  sm_at_raw <- apply(sm, 2, function(s) approx(grid, s, xout = Time)$y)
  
  var_raw <- apply(raw, 1, var, na.rm = TRUE)
  var_smooth <- apply(sm_at_raw, 1, var, na.rm = TRUE)
  
  mean(var_smooth) / mean(var_raw)
}

var_reduction <- mapply(compute_variance_reduction,
                        all_groups, all_fd_groups)

var_reduction



summary_df <- data.frame(
  group = groups_names,
  residual_mean = sapply(residual_errors, mean),
  roughness_mean = sapply(roughness, mean),
  stability = sapply(stability, identity),
  var_ratio = var_reduction
)

summary_df




boxplot(residual_errors, main="Residual Error per Group", las=2)

boxplot(roughness, main="Roughness per Group", las=2)

barplot(var_reduction, names.arg = groups_names,
        main = "Variance Reduction (smoothed/raw)")

```






How to interpret the results
Good smoothing when:

Residual errors: low, no structure

Roughness: moderate, similar across curves

Stability: small values (<5% of signal range)

Var reduction: 0.2–0.7

First derivative smooth

Second derivative not too spiky

Bad smoothing when:

Residual very low + roughness high → overfit

Residual high + roughness low → underfit

Instability high → fragile

Var reduction ≈ 1 → doing nothing

Var reduction < 0.1 → signal destroyed









```{r functional box genotype sex}



#-----Plot Functional boxplot for each group identified by sex and genotype-----



#identifying groups by sex and genotype
male_WT_groups  <- grep("^Males WT",  names(all_fd_groups), value = TRUE)
male_HRM_groups <- grep("^Males HRM", names(all_fd_groups), value = TRUE)
female_WT_groups  <- grep("^Females WT",  names(all_fd_groups), value = TRUE)
female_HRM_groups <- grep("^Females HRM", names(all_fd_groups), value = TRUE)

#matrices for each sex_genotype groupe
male_WT_mat  <- do.call(cbind, lapply(all_fd_groups[male_WT_groups],  function(fd) eval.fd(grid, fd)))
male_HRM_mat <- do.call(cbind, lapply(all_fd_groups[male_HRM_groups], function(fd) eval.fd(grid, fd)))
female_WT_mat  <- do.call(cbind, lapply(all_fd_groups[female_WT_groups],  function(fd) eval.fd(grid, fd)))
female_HRM_mat <- do.call(cbind, lapply(all_fd_groups[female_HRM_groups], function(fd) eval.fd(grid, fd)))


ylim_global_fb <- range(c(male_WT_mat,male_HRM_mat,female_WT_mat,female_HRM_mat ))
  

plot_fb <- function(mat, grid, title, ylim) {

  fbplot(mat, method = "MBD", ylim = ylim)

  title(main = title, xlab = "Time (sec)", ylab = "fEPSP % baseline")

  legend("topright",
         legend = c("median curve","50% central region(non outliers)","bornes des non outlier (whiskers)", "outlier candidates"),
         col    = c("black","magenta3","#0072B2", "red"),
         lwd    = c(2, 20, 2, 1),
         lty    = c(1, 1,1,2),
         cex = 0.7, bty = "n")
}



dir.create("figures_fboxplot_genotypes_sex", showWarnings = FALSE)

# MALES WT
png("figures_fboxplot_genotypes_sex/fbplot_males_WT.png", width=1400, height=900, res=150)
plot_fb(male_WT_mat, grid, "Functional Boxplot – Males WT", ylim_global_fb)
dev.off()

# MALES HRM
png("figures_fboxplot_genotypes_sex/fbplot_males_HRM.png", width=1400, height=900, res=150)
plot_fb(male_HRM_mat, grid, "Functional Boxplot – Males HRM", ylim_global_fb)
dev.off()

# FEMALES WT
png("figures_fboxplot_genotypes_sex/fbplot_females_WT.png", width=1400, height=900, res=150)
plot_fb(female_WT_mat, grid, "Functional Boxplot – Females WT", ylim_global_fb)
dev.off()

# FEMALES HRM
png("figures_fboxplot_genotypes_sex/fbplot_females_HRM.png", width=1400, height=900, res=150)
plot_fb(female_HRM_mat, grid, "Functional Boxplot – Females HRM", ylim_global_fb)
dev.off()

```




