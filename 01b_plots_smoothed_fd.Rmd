---
title: "Smoothed Functional Data — Group Curves"
output: html_document
date: "2025-11-21"
---

```{r plots fd data}

rmarkdown::render("01a_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)


#-------------------------Plot group's curves------------------------


grid <- seq(min(Time), max(Time), length.out = 500)

all_vals <- unlist(lapply(all_fd_groups, function(fd) eval.fd(grid, fd)))
ylim_global <- range(all_vals)
ylim_global


plot_gp_curves <- function(fd_gp, title_gp, col, lty,
                         ylim_global = NULL) {
  
  
  grid <- seq(min(Time), max(Time), length.out = 500)
  mat  <- eval.fd(grid, fd_gp)    
  
  #first curves
  plot(grid, mat[, 1],type='l', col = col,lty=lty, lwd = 2,
       main = title_gp, xlab = "Time (sec)", ylab = "fESPS % of baseline",
       ylim = ylim_global)
  
  #adding the other curves of the group
  if (ncol(mat) > 1) {
    for (i in 2:ncol(mat)) {
      lines(grid, mat[, i],lty= lty, col = col, lwd = 2)
    }
  }
}

if (!dir.exists("figures_smooth_data")) dir.create("figures_smooth_data")

for (i in 1:length(all_fd_groups)) {
  
  file_name <- paste0("figures_smooth_data/", groups_names[i], ".png")
  
  png(filename = file_name, width = 1200, height = 800, res = 150)
  
  plot_gp_curves(
    fd_gp = all_fd_groups[[i]],
    title_gp = groups_names[i],
    col = colors[i],
    lty =lty[i],
    ylim_global = ylim_global
    
    
  )
  abline(h = 150, col = "black", lwd = 2, lty = 2)
  grid()
  
  dev.off()
}

```


```{r nb optimum de bases}

all_matrix <- do.call(cbind, all_groups)  # combine toutes les colonnes
all_matrix <- t(all_matrix)   #transpose because fdataobj will get a Matrix of set cases with dimension (n x m), where n is the number of curves and m are the points observed in each curve.
fdataobj <- fdata(all_matrix)

# Optimisation du nombre de B-splines
res_opt <- optim.basis(
  fdataobj= fdataobj,
  type.CV = GCV.S,
  W = NULL,
  lambda = 0,
  numbasis = floor(seq(ncol(fdataobj)/16, ncol(fdataobj)/2, len = 10)),
  type.basis = "bspline",
  par.CV = list(trim = 0, draw = TRUE),   # draw = TRUE pour visualiser GCV
  verbose = TRUE
)

cat("Nombre optimal de bases :", res_opt$nbasis.opt, "\n")
```




```{r}

if (!dir.exists("figures_fboxplot_genotypes_sex")) dir.create("figures_fboxplot_genotypes_sex")

subgroups <- list(
  Males_WT    = "^Males WT", Males_HRM   = "^Males HRM",
  Females_WT  = "^Females WT", Females_HRM = "^Females HRM"
)


build_mat <- function(pattern) {
  idx <- grep(pattern, names(all_fd_groups))
  do.call(cbind, lapply(all_fd_groups[idx], function(fd) eval.fd(grid, fd)))
}

mats <- lapply(subgroups, build_mat)

ylim_global_fb <- range(unlist(mats))


plot_fb <- function(mat, grid, filename, title, ylim) {
  
  png(filename, width = 1500, height = 1000, res = 150)

  fbplot(mat, method="MBD", color="lightcyan1", outliercol="red3",
         barcol="steelblue1", fullout=TRUE,
         ylim=ylim, xlab="", ylab="", main="", xaxt="n")

  axis(2)
  tick_pos  <- seq(1, length(grid), length.out=7)
  tick_labs <- round(seq(min(grid), max(grid), length.out=7))
  axis(1, at=tick_pos, labels=tick_labs)

  title(main=title, xlab="Time (sec)", ylab="fEPSP % baseline")

  legend("topright",
         legend=c("median","50% central region","bounds","outlier"),
         col=c("black","lightcyan1","steelblue1","red3"),
         lwd=c(2,20,2,1), lty=c(1,1,1,2),
         cex=0.7, bty="n")

  dev.off()
}


for (sg in names(mats)) {
  filename <- paste0("figures_fboxplot_genotypes_sex/fbplot_", tolower(sg), ".png")
  
  plot_fb(
    mat  = mats[[sg]], grid = grid, filename = filename,
    title = paste("Functional Boxplot —", sg), ylim  = ylim_global_fb
  )
}

```



Modified Band Depth (MBD): MBD is defined based on the number of times a given curve is completely contained within the range defined by two other curves from sample. Hence, MBD indicates how central the curve is. Higher the MBD value, more central the curve is. The sample curves are ordered in decreasing value of their MBD implying first curve to be the median curve and last curve as the outlier

