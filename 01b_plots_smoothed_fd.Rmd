---
title: "Smoothed Functional Data — Group Curves"
output: html_document
date: "2025-11-21"
---

```{r plots fd data}

rmarkdown::render("01a_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)
rmarkdown::render("01b_data_preparation.Rmd", envir = globalenv(), quiet = TRUE)


#-------------------------Plot group's curves------------------------


grid <- seq(min(Time), max(Time), length.out = 500)

all_vals <- unlist(lapply(all_fd_groups, function(fd) eval.fd(grid, fd)))
ylim_global <- range(all_vals)
ylim_global


plot_gp_curves <- function(fd_gp, title_gp, col, lty,
                         ylim_global = NULL) {
  
  
  grid <- seq(min(Time), max(Time), length.out = 500)
  mat  <- eval.fd(grid, fd_gp)    
  
  #first curves
  plot(grid, mat[, 1],type='l', col = col,lty=lty, lwd = 2,
       main = title_gp, xlab = "Time (sec)", ylab = "fESPS % of baseline",
       ylim = ylim_global)
  
  #adding the other curves of the group
  if (ncol(mat) > 1) {
    for (i in 2:ncol(mat)) {
      lines(grid, mat[, i],lty= lty, col = col, lwd = 2)
    }
  }
}

if (!dir.exists("figures_smooth_data")) dir.create("figures_smooth_data")

for (i in 1:length(all_fd_groups)) {
  
  file_name <- paste0("figures_smooth_data/", groups_names[i], ".png")
  
  png(filename = file_name, width = 1200, height = 800, res = 150)
  
  plot_gp_curves(
    fd_gp = all_fd_groups[[i]],
    title_gp = groups_names[i],
    col = colors[i],
    lty =lty[i],
    ylim_global = ylim_global
    
    
  )
  abline(h = 150, col = "black", lwd = 2, lty = 2)
  grid()
  
  dev.off()
}

```

```{r}



if (!dir.exists("matrices_cov")) dir.create("matrices_cov")


groups_list <- list(
  "Males"     = grep("^Males", names(all_fd_groups), value = TRUE),
  "Females"     = grep("^Females", names(all_fd_groups), value = TRUE)
)


all_cov_matrices <- list()
grid_list <- list()

for (grp_name in names(groups_list)) {
  group_fds <- all_fd_groups[groups_list[[grp_name]]]
  basis_fd <- group_fds[[1]]$basis
  coeff_list <- lapply(group_fds, function(fd) fd$coefs)
  coeff_mat <- do.call(cbind, coeff_list)
  group_fd <- fd(coef = coeff_mat, basisobj = basis_fd)
  
  cov_fd <- var.fd(group_fd)
  grid <- seq(basis_fd$rangeval[1], basis_fd$rangeval[2], length.out = 500)
  cov_matrix <- eval.bifd(grid, grid, cov_fd)
  
  all_cov_matrices[[grp_name]] <- cov_matrix
  grid_list[[grp_name]] <- grid
}


global_min <- min(sapply(all_cov_matrices, min))
global_max <- max(sapply(all_cov_matrices, max))



for (grp_name in names(groups_list)) {
  cov_matrix <- all_cov_matrices[[grp_name]]
  grid <- grid_list[[grp_name]]
  
  png(filename = paste0("matrices_cov/cov_heatmap_", grp_name, ".png"),
      width = 1200, height = 1000, res = 150)
  
  image(grid, grid, cov_matrix,
        col = topo.colors(50),
        zlim = c(global_min, global_max),  # <-- même échelle pour tous
        xlab = "Time (s)", ylab = "Time (s)",
        main = paste("Covariance fonctionnelle -", grp_name))
  
  dev.off()
}

```






```{r functional box genotype sex}



#-----Plot Functional boxplot for each group identified by sex and genotype-----



#identifying groups by sex and genotype
male_WT_groups  <- grep("^Males WT",  names(all_fd_groups), value = TRUE)
male_HRM_groups <- grep("^Males HRM", names(all_fd_groups), value = TRUE)
female_WT_groups  <- grep("^Females WT",  names(all_fd_groups), value = TRUE)
female_HRM_groups <- grep("^Females HRM", names(all_fd_groups), value = TRUE)

#matrices for each sex_genotype groupe
male_WT_mat  <- do.call(cbind, lapply(all_fd_groups[male_WT_groups],  function(fd) eval.fd(grid, fd)))
male_HRM_mat <- do.call(cbind, lapply(all_fd_groups[male_HRM_groups], function(fd) eval.fd(grid, fd)))
female_WT_mat  <- do.call(cbind, lapply(all_fd_groups[female_WT_groups],  function(fd) eval.fd(grid, fd)))
female_HRM_mat <- do.call(cbind, lapply(all_fd_groups[female_HRM_groups], function(fd) eval.fd(grid, fd)))


ylim_global_fb <- range(c(male_WT_mat,male_HRM_mat,female_WT_mat,female_HRM_mat ))
  

plot_fb <- function(mat, grid, title, ylim) {

  fbplot(mat, method = "MBD", color = "lightcyan1", outliercol = "red3", barcol = "steelblue1", fullout=TRUE, ylim = ylim)

  title(main = title, xlab = "Time (sec)", ylab = "fEPSP % baseline")

  legend("topright",
         legend = c("median curve","50% central region(non outliers)","bornes des non outlier (whiskers)", "outlier candidates"),
         col    = c("black","lightcyan1","steelblue1", "red3"),
         lwd    = c(2, 20, 2, 1),
         lty    = c(1, 1, 1, 2),
         cex = 0.7, bty = "n")
}



dir.create("figures_fboxplot_genotypes_sex", showWarnings = FALSE)

# MALES WT
png("figures_fboxplot_genotypes_sex/fbplot_males_WT.png", width=1400, height=900, res=150)
plot_fb(male_WT_mat, grid, "Functional Boxplot – Males WT", ylim_global_fb)
dev.off()

# MALES HRM
png("figures_fboxplot_genotypes_sex/fbplot_males_HRM.png", width=1400, height=900, res=150)
plot_fb(male_HRM_mat, grid, "Functional Boxplot – Males HRM", ylim_global_fb)
dev.off()

# FEMALES WT
png("figures_fboxplot_genotypes_sex/fbplot_females_WT.png", width=1400, height=900, res=150)
plot_fb(female_WT_mat, grid, "Functional Boxplot – Females WT", ylim_global_fb)
dev.off()

# FEMALES HRM
png("figures_fboxplot_genotypes_sex/fbplot_females_HRM.png", width=1400, height=900, res=150)
plot_fb(female_HRM_mat, grid, "Functional Boxplot – Females HRM", ylim_global_fb)
dev.off()



```





Modified Band Depth (MBD): MBD is defined based on the number of times a given curve is completely contained within the range defined by two other curves from sample. Hence, MBD indicates how central the curve is. Higher the MBD value, more central the curve is. The sample curves are ordered in decreasing value of their MBD implying first curve to be the median curve and last curve as the outlier

